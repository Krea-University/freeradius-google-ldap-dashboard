# Dynamic Domain Configuration for Multi-Domain Support
# This file provides dynamic VLAN assignment based on DOMAIN_CONFIG environment variable
# Auto-generated configuration

# Extract domain from username
if (&User-Name =~ /@(.*)$/) {
	update request {
		Tmp-String-0 := "%{1}"
	}
}

# Check if domain is in our supported list and apply VLAN
# Domain mappings are loaded from domain_mappings.conf file
# Format: domain|vlan|type

# Read domain configuration and set VLAN dynamically
if (&request:Tmp-String-0) {
	# SQL and LDAP authentication for all configured domains
	sql
	ldap
	
	if ((ok || updated) && User-Password && !control:Auth-Type) {
		update control {
			Auth-Type := ldap
			# For Google LDAP, bind using email address instead of DN
			LDAP-UserDn := "%{User-Name}"
		}
		
		# Dynamic VLAN assignment based on domain_mappings.conf
		# This section will be populated by the init script based on DOMAIN_CONFIG
		__DYNAMIC_VLAN_ASSIGNMENT__
	}
}
else {
	# Reject users without proper domain
	update control {
		Auth-Type := Reject
	}
	update reply {
		Reply-Message := "Invalid username format. Please use email address."
	}
}
