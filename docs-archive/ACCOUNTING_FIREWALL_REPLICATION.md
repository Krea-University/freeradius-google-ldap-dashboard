# FreeRADIUS Accounting Replication to Firewall

## Overview

This FreeRADIUS setup includes accounting packet replication to an external firewall for User-ID integration. This document explains the implementation, current status, and how to enable it.

## Current Status

**Firewall accounting replication is DISABLED by default.**

### Why Disabled?

FreeRADIUS 3.x uses **synchronous proxying** via `Proxy-To-Realm`. This means:

1. FreeRADIUS receives accounting packet from client (e.g., NAS/AP)
2. FreeRADIUS logs to SQL database ‚úÖ
3. FreeRADIUS proxies packet to firewall and **WAITS** for response ‚ö†Ô∏è
4. If firewall responds within 20 seconds ‚Üí Client gets Accounting-Response ‚úÖ
5. If firewall doesn't respond ‚Üí FreeRADIUS fails the request ‚Üí Client gets NO response ‚ùå

**Problem**: If your firewall at `10.10.10.1:1813` is not configured or not responding, **accounting breaks for ALL clients**. Clients will retry packets 3 times with no response, causing delays and failures.

### Solution

The replication code is in place but commented out. You can enable it **only after** confirming your firewall is configured and responding.

---

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ Acct    ‚îÇ   FreeRADIUS     ‚îÇ Proxy   ‚îÇ  Firewall  ‚îÇ
‚îÇ (NAS/AP)    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ   172.25.0.4     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ 10.10.10.1 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                         ‚îÇ                           ‚îÇ
       ‚îÇ                         ‚îÇ Logs to MySQL             ‚îÇ
       ‚îÇ                         ‚ñº                           ‚îÇ
       ‚îÇ                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
       ‚îÇ                  ‚îÇ   MariaDB  ‚îÇ                     ‚îÇ
       ‚îÇ                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
       ‚îÇ                         ‚îÇ                           ‚îÇ
       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  WAITS for firewall      ‚îÇ
       ‚îÇ  Acct-Response          ‚îÇ  (20 seconds timeout)     ‚îÇ
       ‚îÇ  (if firewall OK)       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                         ‚îÇ
```

### Full Email Preservation

The `pre-proxy` section restores full email addresses before sending to firewall:

- **Input**: `User-Name = "user@yourdomain.com"`
- **After suffix module**: `Stripped-User-Name = "user"`, `Realm = "yourdomain.com"`
- **Before proxy**: Reconstructs `User-Name = "user@yourdomain.com"`
- **Firewall receives**: Full email address for User-ID mapping ‚úÖ

---

## Configuration Files

### 1. Environment Variables (`.env`)

```bash
# Firewall Accounting Replication
ENABLE_ACCT_REPLICATION=true
FIREWALL_ACCT_SERVER=10.10.10.1
FIREWALL_ACCT_PORT=1813
FIREWALL_ACCT_SECRET=testing123
```

### 2. Proxy Configuration (`configs/proxy.conf`)

```
home_server firewall_acct {
    type = acct
    ipaddr = 10.10.10.1
    port = 1813
    secret = testing123
    response_window = 20
    zombie_period = 40
    status_check = none
}

home_server_pool firewall_acct_pool {
    type = fail-over
    home_server = firewall_acct
}

realm firewall_accounting {
    acct_pool = firewall_acct_pool
}
```

### 3. Accounting Section (`configs/default`)

```
accounting {
    sql
    
    # --- BEGIN FIREWALL ACCOUNTING REPLICATION ---
    # Dynamically generated by init.sh
    # Currently DISABLED - see init.sh to enable
    # --- END FIREWALL ACCOUNTING REPLICATION ---
    
    detail
    unix
}
```

### 4. Pre-Proxy Email Restoration (`configs/default`)

```
pre-proxy {
    # Restore full email address for firewall accounting
    if (&Stripped-User-Name && &Realm && (&control:Proxy-To-Realm == "firewall_accounting")) {
        update proxy-request {
            User-Name := "%{Stripped-User-Name}@%{Realm}"
        }
    }
}
```

---

## How to Enable Replication

### Prerequisites

1. **Firewall Configuration**:
   - RADIUS accounting listener on UDP port 1813
   - Shared secret matches `FIREWALL_ACCT_SECRET` in `.env`
   - User-ID integration configured to accept accounting packets
   - Test with: `echo "Acct-Status-Type=Start,User-Name=test@yourdomain.com" | radclient 10.10.10.1:1813 acct testing123`

2. **Network Connectivity**:
   - FreeRADIUS container (172.25.0.4) can reach firewall (10.10.10.1)
   - UDP port 1813 not blocked by firewalls
   - Test: `docker exec freeradius-google-ldap ping -c 3 10.10.10.1`

### Step 1: Modify `init.sh`

Find this section (around line 260):

```bash
# UNCOMMENT TO ENABLE:
# update control {
#    Proxy-To-Realm := "firewall_accounting"
# }
```

Change to:

```bash
# ENABLED: Proxying accounting to firewall
update control {
   Proxy-To-Realm := "firewall_accounting"
}
```

### Step 2: Rebuild and Restart

```powershell
docker-compose build freeradius
docker-compose up -d freeradius
Start-Sleep -Seconds 8
```

### Step 3: Verify Startup

```powershell
docker logs freeradius-google-ldap --tail 30
# Should see: "Accounting replication to firewall 10.10.10.1:1813 enabled successfully"
```

### Step 4: Test Accounting

```powershell
echo "Acct-Status-Type=Start,Framed-IP-Address=10.1.156.185,User-Name=user@yourdomain.com,Acct-Session-Id=ENABLE-TEST-001" | docker exec -i freeradius-google-ldap radclient -x localhost:1813 acct testing123
```

**Expected**:
- Single `Sent Accounting-Request` (no retries)
- `Received Accounting-Response` within 1-2 seconds
- FreeRADIUS logs show `Sent Accounting-Request Id XX to 10.10.10.1:1813`
- Firewall logs show received packet with full email address

**If firewall doesn't respond**:
- Client will retry packet 3 times (20-second intervals)
- Accounting will fail
- **DISABLE REPLICATION IMMEDIATELY** by commenting out `Proxy-To-Realm` and rebuilding

### Step 5: Monitor

```powershell
# Check for errors
docker logs freeradius-google-ldap 2>&1 | Select-String "ERROR|zombie|dead|10.10.10.1"

# Verify full email sent to firewall
docker logs freeradius-google-ldap 2>&1 | Select-String "Sent Accounting-Request.*to 10.10.10.1" -Context 2,0
```

---

## Firewall Configuration Examples

### Palo Alto Networks

```xml
<radius-accounting>
  <server>
    <ip-address>172.25.0.4</ip-address>
    <port>1813</port>
    <secret>testing123</secret>
  </server>
</radius-accounting>

<user-id>
  <radius-accounting>
    <enabled>yes</enabled>
    <timeout>3600</timeout>
  </radius-accounting>
</user-id>
```

### Fortinet FortiGate

```
config user radius
    edit "FreeRADIUS-Accounting"
        set server "172.25.0.4"
        set secret "testing123"
        set acct-port 1813
        set rsso enable
    next
end

config system settings
    set auth-http-port 1000
    set auth-https-port 1003
    set auth-keepalive enable
end
```

### Cisco ISE

Not applicable - Cisco ISE is typically the RADIUS server, not the client.

### Generic RADIUS Configuration

Most enterprise firewalls support RADIUS accounting:

1. **Add RADIUS server**: `172.25.0.4:1813`
2. **Shared secret**: `testing123`
3. **Enable User-ID/RSSO**: Map `User-Name` attribute to user identity
4. **Session timeout**: 3600 seconds (1 hour)
5. **Attributes to log**:
   - `User-Name` (full email)
   - `Framed-IP-Address` (client IP)
   - `Acct-Session-Id` (session tracking)
   - `Calling-Station-Id` (MAC address)
   - `Acct-Status-Type` (Start/Stop/Interim-Update)

---

## Troubleshooting

### Problem: Client retries accounting packets 3 times

**Symptom**:
```
Sent Accounting-Request Id 116 from 0.0.0.0:38216 to 127.0.0.1:1813
[20 seconds pass]
Sent Accounting-Request Id 116 from 0.0.0.0:38216 to 127.0.0.1:1813
[20 seconds pass]
Sent Accounting-Request Id 116 from 0.0.0.0:38216 to 127.0.0.1:1813
```

**Cause**: Firewall not responding to FreeRADIUS proxy requests.

**Fix**:
1. **Disable replication** by commenting out `Proxy-To-Realm` in `init.sh`
2. Rebuild: `docker-compose build freeradius && docker-compose up -d`
3. Fix firewall configuration
4. Test firewall directly: `radclient 10.10.10.1:1813 acct testing123 <<< "Acct-Status-Type=Start"`
5. Re-enable replication only after firewall responds

---

### Problem: Firewall receives username instead of full email

**Symptom**: Firewall logs show `User-Name = "user"` instead of `"user@yourdomain.com"`.

**Cause**: `pre-proxy` section not executing or misconfigured.

**Fix**:
```powershell
# Check pre-proxy configuration
docker exec freeradius-google-ldap grep -A 8 "^pre-proxy {" /etc/freeradius/sites-enabled/default

# Should see:
# if (&Stripped-User-Name && &Realm && (&control:Proxy-To-Realm == "firewall_accounting")) {
#     update proxy-request {
#         User-Name := "%{Stripped-User-Name}@%{Realm}"
#     }
# }

# Verify in logs
docker logs freeradius-google-ldap 2>&1 | Select-String "pre-proxy|User-Name :=|Sent Accounting-Request.*to 10.10.10.1" -Context 2,2
```

---

### Problem: "ERROR: Failing proxied request for user"

**Symptom**:
```
(1) ERROR: Failing proxied request for user "user", due to lack of any response from home server 10.10.10.1 port 1813
```

**Cause**: Firewall didn't respond within 20 seconds.

**Fix**:
1. Verify firewall is online: `ping 10.10.10.1`
2. Check firewall RADIUS service is listening on UDP 1813
3. Verify shared secret matches between FreeRADIUS and firewall
4. Check firewall logs for authentication failures or mismatched secrets
5. If firewall is down/misconfigured, **disable replication** in `init.sh`

---

### Problem: Firewall marked as "zombie" or "dead"

**Symptom**:
```
Marking home server 10.10.10.1 port 1813 as zombie
Home server 10.10.10.1 port 1813 is now marked dead
```

**Cause**: Firewall didn't respond to multiple consecutive accounting packets.

**Fix**:
1. Fix firewall configuration
2. **Disable replication** in `init.sh` until firewall is fixed
3. Restart FreeRADIUS after fixing firewall:
   ```powershell
   docker-compose restart freeradius
   ```
4. Monitor for 5 minutes to ensure firewall stays responsive

---

## Testing Commands

### Test Accounting Without Replication (Current Setup)

```powershell
# Should receive immediate response
echo "Acct-Status-Type=Start,Framed-IP-Address=10.1.156.185,User-Name=user@yourdomain.com,Acct-Session-Id=TEST-NO-PROXY" | docker exec -i freeradius-google-ldap radclient -x localhost:1813 acct testing123
```

### Test Accounting With Replication (After Enabling)

```powershell
# Should receive response within 1-2 seconds if firewall responds
echo "Acct-Status-Type=Start,Framed-IP-Address=10.1.156.185,User-Name=user@yourdomain.com,Acct-Session-Id=TEST-WITH-PROXY,Calling-Station-Id=AA-BB-CC-DD-EE-FF" | docker exec -i freeradius-google-ldap radclient -x localhost:1813 acct testing123
```

### Test Firewall Directly

```powershell
# Test if firewall RADIUS is working
docker exec freeradius-google-ldap bash -c 'echo "Acct-Status-Type=Start,User-Name=test.user@yourdomain.com,Framed-IP-Address=10.1.156.185" | radclient -x 10.10.10.1:1813 acct testing123'
```

### Monitor Accounting in Real-Time

```powershell
# Terminal 1: Watch FreeRADIUS logs
docker logs -f freeradius-google-ldap

# Terminal 2: Send accounting packet
echo "Acct-Status-Type=Start,User-Name=user@yourdomain.com,Acct-Session-Id=MONITOR-TEST" | docker exec -i freeradius-google-ldap radclient -x localhost:1813 acct testing123
```

---

## Alternative Approaches (Future Implementation)

If synchronous proxy continues to cause issues, consider these alternatives:

### 1. Detail Files + radrelay (Recommended for Production)

**How it works**:
- FreeRADIUS writes accounting packets to detail file
- Responds immediately to client
- Separate `radrelay` daemon reads detail file and forwards to firewall
- If firewall is down, packets accumulate in detail file
- When firewall comes back, `radrelay` sends buffered packets

**Implementation**:
```
accounting {
    sql
    detail firewall_detail {
        filename = "/var/log/freeradius/firewall/detail"
    }
    detail  # Normal detail file
}
```

Then run: `radrelay -d /etc/freeradius -D /var/log/freeradius/firewall -a 10.10.10.1:1813 -s testing123`

**Requires**: `radrelay` utility (not included in freeradius/freeradius-server:3.0.23 Docker image)

### 2. Exec Module with radclient

**How it works**:
- Use `exec` module to fork radclient process
- Sends packet in background without blocking

**Implementation**:
```
accounting {
    sql
    exec {
        wait = no
        program = "/usr/bin/radclient -x 10.10.10.1:1813 acct testing123"
        input_pairs = request
    }
}
```

**Downside**: Higher overhead, potential performance impact

### 3. External Syslog-Based Replication

**How it works**:
- Log accounting to syslog with full details
- External script reads syslog and forwards to firewall
- Completely decoupled from FreeRADIUS

**Requires**: Additional infrastructure and scripts

---

## Summary

- ‚úÖ Accounting works perfectly without firewall replication
- ‚úÖ Full email preservation logic implemented and tested
- ‚úÖ Firewall proxy configuration in place, currently disabled
- ‚ö†Ô∏è Enable replication **only after** confirming firewall is configured and responding
- ‚ö†Ô∏è Monitor for "zombie" or "dead" home server errors after enabling
- üìù Future: Implement detail file + radrelay for production-grade async replication

---

## Related Documentation

- [ACCOUNTING_REPLICATION.md](./ACCOUNTING_REPLICATION.md) - Full technical documentation
- [QUICKSTART_ACCOUNTING.md](./QUICKSTART_ACCOUNTING.md) - Quick reference guide
- [FIREWALL_SETUP_CHECKLIST.md](./FIREWALL_SETUP_CHECKLIST.md) - Firewall configuration checklist
- [test-accounting-replication.ps1](./test-accounting-replication.ps1) - Automated test script

---

**Last Updated**: 2025-01-18  
**FreeRADIUS Version**: 3.0.23  
**Status**: Accounting working, firewall replication disabled by default
